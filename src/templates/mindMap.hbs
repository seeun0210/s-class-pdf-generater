<!-- src/pdf/templates/mindmap-analysis.hbs -->
<html lang='ko'>
  <head>
    <meta charset='UTF-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0' />
    <title>탐구 과정 마인드맵 분석 보고서</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Noto Sans KR', sans-serif;
        line-height: 1.8;
        color: #000;
        margin: 0;
        padding: 40px;
        background-color: #ffffff;
        font-size: 14px;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
        padding-bottom: 20px;
        border-bottom: 2px solid #ddd;
      }

      .header-title {
        font-size: 22px;
        font-weight: 700;
        color: #000;
        margin-bottom: 10px;
      }

      .header-date {
        font-size: 14px;
        color: #666;
      }

      .section {
        margin-bottom: 40px;
        page-break-inside: avoid;
      }

      .section-title {
        font-size: 18px;
        font-weight: 700;
        color: #000;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #333;
      }

      .career-path {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 40px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .career-path-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 12px;
      }

      .activity-card {
        background-color: #f9f9f9;
        border-left: 5px solid #4a90e2;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 15px;
      }

      .activity-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .activity-name {
        font-size: 17px;
        font-weight: 700;
        color: #000;
      }

      .activity-group {
        background-color: #e3f2fd;
        color: #1976d2;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
      }

      .activity-info {
        display: flex;
        gap: 15px;
        margin-bottom: 12px;
        font-size: 13px;
        color: #666;
      }

      .activity-description {
        font-size: 14px;
        color: #444;
        line-height: 1.8;
      }

      .core-badge {
        display: inline-block;
        background-color: #ffeb3b;
        color: #f57f17;
        padding: 3px 10px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 5px;
      }

      .content-box {
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 5px;
        white-space: pre-wrap;
        font-size: 14px;
        line-height: 1.8;
        margin-bottom: 20px;
        border-left: 4px solid #4a90e2;
      }

      .subsection-title {
        font-size: 15px;
        font-weight: 600;
        color: #333;
        margin: 20px 0 12px 0;
      }

      .keywords-box {
        background-color: #fff9e6;
        padding: 15px;
        border-radius: 5px;
        border-left: 3px solid #ffd700;
      }

      .keyword-tag {
        display: inline-block;
        background-color: #ffeb3b;
        color: #333;
        padding: 4px 10px;
        border-radius: 10px;
        font-size: 12px;
        margin: 3px;
      }

      .page-break {
        page-break-before: always;
      }

      .activity-table {
        width: 100%;
        border-collapse: collapse;
        background-color: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 20px;
      }

      .activity-table thead {
        background-color: #4a90e2;
        color: white;
      }

      .activity-table th {
        padding: 12px 8px;
        text-align: left;
        font-weight: 600;
        font-size: 13px;
        border-bottom: 2px solid #357abd;
      }

      .activity-table td {
        padding: 12px 8px;
        border-bottom: 1px solid #e0e0e0;
        font-size: 13px;
        vertical-align: top;
      }

      .activity-table tbody tr:hover {
        background-color: #f5f9ff;
      }

      .activity-table tbody tr:last-child td {
        border-bottom: none;
      }

      .table-name {
        font-weight: 600;
        color: #000;
      }

      .table-group {
        background-color: #e3f2fd;
        color: #1976d2;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        display: inline-block;
      }

      .table-description {
        color: #555;
        line-height: 1.6;
      }

      @media print {
        body {
          padding: 20px;
        }
        .page-break {
          page-break-before: always;
        }
      }
    </style>
  </head>
  <body>
    <!-- 헤더 -->
    <div class='header'>
      <div class='header-title'>탐구 과정 마인드맵 분석 보고서</div>
      <div class='header-date'>생성일: {{generatedAt}}</div>
    </div>

    <!-- 진로 경로 -->
    {{#if career_path}}
      <div class='career-path'>
        <div class='career-path-title'>진로 경로</div>
        <div style='font-size: 18px;'>{{career_path}}</div>
      </div>
    {{/if}}

    <!-- 핵심 활동 -->
    {{#if all_activities}}
      {{#if all_activities.length}}
        <div class='section'>
          <h2 class='section-title'>활동 내역</h2>
          <table class='activity-table'>
            <thead>
              <tr>
                <th style='width: 180px;'>이름</th>
                <th style='width: 100px;'>그룹</th>
                <th style='width: 80px;'>학년</th>
                <th style='width: 70px;'>핵심</th>
                <th>설명</th>
              </tr>
            </thead>
            <tbody>
              {{#each all_activities}}
                <tr>
                  <td>
                    <div class='table-name'>{{name}}</div>
                  </td>
                  <td>
                    <span class='table-group'>{{group}}</span>
                  </td>
                  <td>{{#if grade}}{{grade}}{{else}}-{{/if}}</td>
                  <td>
                    {{#if (eq id ../core_activity_ids.[@index])}}
                      <span class='core-badge'>핵심</span>
                    {{else}}
                      -
                    {{/if}}
                  </td>
                  <td class='table-description'>{{#if description}}{{description}}{{else}}-{{/if}}</td>
                </tr>
              {{/each}}
            </tbody>
          </table>
        </div>
      {{/if}}
    {{/if}}

    <!-- 마인드맵 네트워크 그래프 -->
    {{#if all_activities}}
      {{#if all_activities.length}}
        <div class='section page-break'>
          <h2 class='section-title'>탐구 과정 마인드맵</h2>
          <div id='mindmap-container' style='background: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 40px; min-height: 900px; overflow: visible;'>
            <svg id='mindmap-svg' width='100%' height='900' viewBox='0 0 1000 900' xmlns='http://www.w3.org/2000/svg'>
              <!-- Graph will be drawn by JavaScript -->
            </svg>
          </div>
        </div>
        
        <script>
          (function () {
            const activities = {{{toJSON all_activities}}} || [];
            const links = {{{toJSON links}}} || [];
            const coreIds = {{{toJSON core_activity_ids}}} || [];

            const svg = document.getElementById('mindmap-svg');
            if (!svg || !activities.length) return;

            // Layout config
            const width = 1000;
            const height = 900;
            const padding = { left: 60, right: 60, top: 80, bottom: 80 };
            const columnGap = 280; // column width
            const rowGap = 55; // vertical spacing
            const nodeBaseR = 22;

            // Distinct groups as columns (by grade)
            const groups = Array.from(new Set(activities.map(a => a.grade || '미분류')));
            const groupToIndex = new Map(groups.map((g, i) => [g, i]));

            // Color palette per group (repeat if overflow)
            const palette = [
              '#4a90e2', '#7e57c2', '#26a69a', '#ef5350', '#ffa726', '#8d6e63', '#42a5f5', '#66bb6a', '#ab47bc', '#26c6da', '#ffca28', '#5c6bc0'
            ];
            const groupToColor = new Map(groups.map((g, i) => [g, palette[i % palette.length]]));

            // Column x positions
            const startX = padding.left + 40; // little offset
            const xForGroup = (g) => startX + (groupToIndex.get(g || '기타') || 0) * columnGap;

            // Draw vertical separators and column headers
            groups.forEach((g, idx) => {
              const x = xForGroup(g);
              const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
              line.setAttribute('x1', x);
              line.setAttribute('x2', x);
              line.setAttribute('y1', padding.top);
              line.setAttribute('y2', height - padding.bottom);
              line.setAttribute('stroke', '#cccccc');
              line.setAttribute('stroke-dasharray', '6 6');
              line.setAttribute('opacity', '0.8');
              svg.appendChild(line);

              const header = document.createElementNS('http://www.w3.org/2000/svg', 'text');
              header.setAttribute('x', x);
              header.setAttribute('y', padding.top - 12);
              header.setAttribute('text-anchor', 'middle');
              header.setAttribute('fill', '#666');
              header.setAttribute('font-size', '13');
              header.setAttribute('font-weight', '600');
              header.textContent = g;
              svg.appendChild(header);
            });

            // Compute row per group (to avoid overlap)
            const positions = new Map(); // id -> {x,y,r,color}
            const groupRowCount = new Map(groups.map(g => [g, 0]));
            activities.forEach((a) => {
              const g = a.grade || '미분류';
              const row = groupRowCount.get(g) || 0;
              const x = xForGroup(g);
              const y = padding.top + 40 + row * rowGap;
              groupRowCount.set(g, row + 1);

              const isCore = coreIds.includes(a.id);
              const r = isCore ? nodeBaseR + 6 : nodeBaseR;
              const color = groupToColor.get(g) || '#4a90e2';
              positions.set(a.id, { x, y, r, color, isCore, name: a.name || ('Activity ' + a.id) });
            });

            // Draw links behind nodes
            links.forEach((link) => {
              const s = positions.get(link.source);
              const t = positions.get(link.target);
              if (!s || !t) return;

              const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
              line.setAttribute('x1', s.x);
              line.setAttribute('y1', s.y);
              line.setAttribute('x2', t.x);
              line.setAttribute('y2', t.y);
              line.setAttribute('stroke', '#b0b0b0');
              line.setAttribute('stroke-width', '2');
              line.setAttribute('opacity', '0.6');
              svg.appendChild(line);
            });

            // Draw nodes
            positions.forEach((p) => {
              const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
              circle.setAttribute('cx', p.x);
              circle.setAttribute('cy', p.y);
              circle.setAttribute('r', p.r);
              circle.setAttribute('fill', p.color);
              circle.setAttribute('opacity', '0.9');
              circle.setAttribute('stroke', '#444');
              circle.setAttribute('stroke-width', p.isCore ? '3' : '2');
              svg.appendChild(circle);

              const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
              text.setAttribute('x', p.x);
              text.setAttribute('y', p.y + 4);
              text.setAttribute('text-anchor', 'middle');
              text.setAttribute('fill', 'white');
              text.setAttribute('font-size', p.isCore ? '13' : '12');
              text.setAttribute('font-weight', '700');
              text.setAttribute('font-family', 'Noto Sans KR');
              const label = p.name.length > 10 ? (p.name.substring(0, 10) + '…') : p.name;
              text.textContent = label;
              svg.appendChild(text);
            });

            // Legend
            const legendY = height - padding.bottom + 30;
            let legendX = padding.left;
            groups.forEach((g) => {
              const color = groupToColor.get(g) || '#4a90e2';
              const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
              dot.setAttribute('cx', legendX);
              dot.setAttribute('cy', legendY);
              dot.setAttribute('r', 6);
              dot.setAttribute('fill', color);
              svg.appendChild(dot);

              const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
              label.setAttribute('x', legendX + 12);
              label.setAttribute('y', legendY + 4);
              label.setAttribute('fill', '#333');
              label.setAttribute('font-size', '12');
              label.setAttribute('font-family', 'Noto Sans KR');
              label.textContent = g;
              svg.appendChild(label);

              legendX += Math.max(120, g.length * 12 + 40);
            });
          })();
        </script>
      {{/if}}
    {{/if}}

    <!-- 요약 -->
    {{#if summary}}
      <div class='section page-break'>
        <h2 class='section-title'>요약</h2>
        
        {{#if summary.title}}
          <h3 class='subsection-title'>{{summary.title}}</h3>
        {{/if}}

        {{#if summary.introduction}}
          <div class='content-box'>{{summary.introduction}}</div>
        {{/if}}

        {{#if summary.keywords}}
          <div class='keywords-box'>
            <div style='font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #333;'>핵심 키워드</div>
            <div class='keyword-tag'>{{summary.keywords}}</div>
          </div>
        {{/if}}

        {{#if summary.strengths}}
          <h3 class='subsection-title'>강점</h3>
          <div class='content-box' style='background-color: #f0f8f0; border-left-color: #90ee90;'>
            {{summary.strengths}}
          </div>
        {{/if}}

        {{#if summary.conclusion}}
          <h3 class='subsection-title'>결론</h3>
          <div class='content-box' style='background-color: #fff9e6; border-left-color: #ffd700;'>
            {{summary.conclusion}}
          </div>
        {{/if}}
      </div>
    {{/if}}

    <!-- 심층 분석 -->
    {{#if in_depth_analysis}}
      <div class='section page-break'>
        <h2 class='section-title'>심층 분석</h2>

        {{#if in_depth_analysis.connectivity}}
          <h3 class='subsection-title'>연계성 분석</h3>
          
          {{#if in_depth_analysis.connectivity.introduction}}
            <div class='content-box'>{{in_depth_analysis.connectivity.introduction}}</div>
          {{/if}}

          {{#if in_depth_analysis.connectivity.horizontal}}
            <h4 style='font-size: 13px; font-weight: 600; color: #555; margin-top: 12px;'>수평적 연계</h4>
            <div class='content-box' style='background-color: #f9f9f9; border-left-color: #4a90e2;'>{{in_depth_analysis.connectivity.horizontal}}</div>
          {{/if}}

          {{#if in_depth_analysis.connectivity.vertical}}
            <h4 style='font-size: 13px; font-weight: 600; color: #555; margin-top: 12px;'>수직적 연계</h4>
            <div class='content-box' style='background-color: #f9f9f9; border-left-color: #4a90e2;'>{{in_depth_analysis.connectivity.vertical}}</div>
          {{/if}}
        {{/if}}

        {{#if in_depth_analysis.deepening}}
          <h3 class='subsection-title'>심화 분석</h3>
          
          {{#if in_depth_analysis.deepening.introduction}}
            <div class='content-box'>{{in_depth_analysis.deepening.introduction}}</div>
          {{/if}}

          {{#if in_depth_analysis.deepening.deepening}}
            <h4 style='font-size: 13px; font-weight: 600; color: #555; margin-top: 12px;'>심화 활동</h4>
            <div class='content-box' style='background-color: #f9f9f9; border-left-color: #4a90e2;'>{{in_depth_analysis.deepening.deepening}}</div>
          {{/if}}

          {{#if in_depth_analysis.deepening.expansion}}
            <h4 style='font-size: 13px; font-weight: 600; color: #555; margin-top: 12px;'>확장 활동</h4>
            <div class='content-box' style='background-color: #f9f9f9; border-left-color: #4a90e2;'>{{in_depth_analysis.deepening.expansion}}</div>
          {{/if}}
        {{/if}}
      </div>
    {{/if}}
  </body>
</html>
